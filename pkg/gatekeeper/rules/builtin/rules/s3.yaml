version: "1"
metadata:
  name: "S3 Security Rules"
  description: "Security rules for AWS S3 buckets"

rules:
  - id: S3_001
    name: "S3 bucket must have encryption"
    description: "S3 buckets should have server-side encryption enabled to protect data at rest"
    severity: error
    resource_type: aws_s3_bucket
    condition:
      operator: any
      conditions:
        - attribute: server_side_encryption_configuration
          operator: exists
        # Also check for the newer separate resource pattern
        - attribute: bucket
          operator: exists
    message: "S3 bucket '{{.resource_name}}' does not have server-side encryption configured"
    remediation: |
      Add a server_side_encryption_configuration block to your S3 bucket:

      resource "aws_s3_bucket_server_side_encryption_configuration" "example" {
        bucket = aws_s3_bucket.{{.resource_name}}.id
        rule {
          apply_server_side_encryption_by_default {
            sse_algorithm = "aws:kms"
          }
        }
      }
    tags:
      - security
      - s3
      - encryption

  - id: S3_002
    name: "S3 bucket should have versioning enabled"
    description: "S3 buckets should have versioning enabled to protect against accidental deletion"
    severity: warning
    resource_type: aws_s3_bucket
    condition:
      attribute: versioning.enabled
      operator: equals
      value: true
    message: "S3 bucket '{{.resource_name}}' does not have versioning enabled"
    remediation: |
      Enable versioning on your S3 bucket:

      resource "aws_s3_bucket_versioning" "example" {
        bucket = aws_s3_bucket.{{.resource_name}}.id
        versioning_configuration {
          status = "Enabled"
        }
      }
    tags:
      - security
      - s3
      - data-protection

  - id: S3_003
    name: "S3 bucket should block public access"
    description: "S3 buckets should have public access blocked unless explicitly required"
    severity: error
    resource_type: aws_s3_bucket_public_access_block
    condition:
      operator: all
      conditions:
        - attribute: block_public_acls
          operator: equals
          value: true
        - attribute: block_public_policy
          operator: equals
          value: true
        - attribute: ignore_public_acls
          operator: equals
          value: true
        - attribute: restrict_public_buckets
          operator: equals
          value: true
    message: "S3 bucket '{{.resource_name}}' does not have all public access blocks enabled"
    remediation: |
      Add a public access block configuration:

      resource "aws_s3_bucket_public_access_block" "example" {
        bucket = aws_s3_bucket.example.id

        block_public_acls       = true
        block_public_policy     = true
        ignore_public_acls      = true
        restrict_public_buckets = true
      }
    tags:
      - security
      - s3
      - public-access

  - id: S3_004
    name: "S3 bucket should have logging enabled"
    description: "S3 buckets should have access logging enabled for audit purposes"
    severity: warning
    resource_type: aws_s3_bucket
    condition:
      attribute: logging
      operator: exists
    message: "S3 bucket '{{.resource_name}}' does not have access logging enabled"
    remediation: |
      Enable access logging on your S3 bucket:

      resource "aws_s3_bucket_logging" "example" {
        bucket = aws_s3_bucket.{{.resource_name}}.id

        target_bucket = aws_s3_bucket.log_bucket.id
        target_prefix = "log/{{.resource_name}}/"
      }
    tags:
      - security
      - s3
      - logging
      - audit
