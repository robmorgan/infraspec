name: Continuous Feature Validation

on:
  schedule:
    # Every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      feature_filter:
        description: 'Filter features by path (e.g., aws/s3, terraform)'
        type: string
        default: ''

env:
  GO_VERSION: '1.24'

# Required permissions for creating issues on failure
permissions:
  contents: read
  issues: write

jobs:
  validate-features:
    name: Validate Features with Embedded Emulator
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build InfraSpec CLI
        run: go build -o bin/infraspec ./cmd/infraspec

      - name: Verify CLI
        run: |
          ./bin/infraspec --help
          ./bin/infraspec --version || true

      - name: Run Feature Tests
        id: feature_test
        run: |
          FILTER="${{ inputs.feature_filter }}"

          # Set up environment
          export AWS_ACCESS_KEY_ID=test
          export AWS_SECRET_ACCESS_KEY=test
          export AWS_DEFAULT_REGION=us-east-1

          # Check if features directory exists
          if [ ! -d "features" ]; then
            echo "No features directory found, skipping"
            echo "tests_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "tests_found=true" >> $GITHUB_OUTPUT

          # Build feature path
          FEATURE_PATH="features/"
          if [ -n "$FILTER" ]; then
            FEATURE_PATH="features/$FILTER"
          fi

          echo "Running with embedded emulator"

          # Run tests and capture results
          PASSED=0
          FAILED=0
          TOTAL=0

          # Find all .feature files
          for feature_file in $(find "$FEATURE_PATH" -name "*.feature" 2>/dev/null); do
            TOTAL=$((TOTAL + 1))
            feature_name=$(basename "$feature_file" .feature)
            echo "Testing: $feature_file"

            if ./bin/infraspec "$feature_file" > /tmp/feature-output.log 2>&1; then
              echo "  ✅ PASSED: $feature_name"
              PASSED=$((PASSED + 1))
            else
              echo "  ❌ FAILED: $feature_name"
              cat /tmp/feature-output.log
              FAILED=$((FAILED + 1))
            fi
          done

          echo ""
          echo "=========================================="
          echo "Results: $PASSED passed, $FAILED failed, $TOTAL total"
          echo "=========================================="

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          if [ $FAILED -gt 0 ]; then
            exit 1
          fi
        continue-on-error: true

      - name: Report Results
        run: |
          echo "## Feature Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.feature_test.outputs.tests_found }}" = "false" ]; then
            echo "No feature tests found." >> $GITHUB_STEP_SUMMARY
          else
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | ${{ steps.feature_test.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | ${{ steps.feature_test.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Total | ${{ steps.feature_test.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Issue on Failure
        if: failure() && steps.feature_test.outputs.failed > 0
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Feature Validation Failures Detected';
            const body = `
            ## Feature Validation Failed

            **Workflow Run:** [View Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ### Results
            - Passed: ${{ steps.feature_test.outputs.passed }}
            - Failed: ${{ steps.feature_test.outputs.failed }}
            - Total: ${{ steps.feature_test.outputs.total }}

            Please investigate the failing feature tests and fix any issues.
            `;

            // Check for existing issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'feature-validation-failure',
              state: 'open'
            });

            if (issues.data.length > 0) {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['feature-validation-failure', 'bug']
              });
            }

  # Unit tests validation
  validate-unit-tests:
    name: Validate Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run Unit Tests
        id: unit_tests
        run: |
          if go test -v ./... 2>&1 | tee /tmp/test-output.log; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true

      - name: Run Emulator Service Tests
        id: emulator_tests
        run: |
          if go test -v ./internal/emulator/... 2>&1 | tee /tmp/emulator-test-output.log; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true

      - name: Report Results
        run: |
          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| All Tests | ${{ steps.unit_tests.outputs.status == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Emulator Tests | ${{ steps.emulator_tests.outputs.status == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Create Issue on Failure
        if: steps.unit_tests.outputs.status == 'failure' || steps.emulator_tests.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Unit Test Failures Detected';
            const body = `
            ## Unit Tests Failed

            **Workflow Run:** [View Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ### Results
            - All Tests: ${{ steps.unit_tests.outputs.status }}
            - Emulator Tests: ${{ steps.emulator_tests.outputs.status }}

            Please investigate the failing tests and fix any issues.
            `;

            // Check for existing issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'unit-test-failure',
              state: 'open'
            });

            if (issues.data.length > 0) {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['unit-test-failure', 'bug']
              });
            }
